<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>院內郵件計數系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        /* 基礎字體與背景 */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
            background-color: #f8fafc; /* Tailwind gray-50 */
        }

        /* ... (其他 CSS 樣式不變) ... */
        
        /* 單位按鈕樣式 */
        .dept-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10+ */
            user-select: none; /* Standard */
        }
        
        /* ... (其他 CSS 樣式不變) ... */
        
        /* *** 新增分析 Modal 的分頁樣式 *** */
        .analysis-tab {
            padding: 0.75rem 1.25rem;
            font-size: 1rem;
            font-weight: 600;
            color: #4b5563; /* text-gray-600 */
            background-color: #f3f4f6; /* bg-gray-100 */
            border-radius: 0.375rem; /* rounded-md */
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .analysis-tab:hover {
            background-color: #e5e7eb; /* bg-gray-200 */
        }
        .analysis-tab.active {
            background-color: #4f46e5; /* bg-indigo-600 */
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* *** 確保圖表容器有高度 *** */
        .chart-container {
            min-height: 400px;
            width: 100%;
        }
        
        /* AI 分析結果的樣式 */
        #ai-suggestion-content ul {
            list-style-type: disc;
            list-style-position: outside;
            padding-left: 1.5rem;
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }
         #ai-suggestion-content li {
             margin-bottom: 0.5rem;
             color: #374151;
             line-height: 1.6;
         }
        #ai-suggestion-content p {
            margin-bottom: 1rem;
            color: #374151;
            line-height: 1.6;
        }
         #ai-suggestion-content strong {
            font-weight: 600;
            color: #1f2937;
         }
    </style>
</head>
<body>

    <header class="bg-white shadow-sm sticky top-0 z-20">
        </header>

    <div id="counter-page">
        <footer class="control-bar fixed bottom-0 left-0 right-0 bg-white p-4 border-t border-gray-200">
            <div class="max-w-7xl mx-auto flex flex-wrap items-center justify-between gap-3">
                <div class="flex items-center space-x-4">
                    </div>

                <div class="flex space-x-2 flex-wrap gap-2 justify-end">
                    </div>
            </div>
        </footer>
    </div>
    <div id="instructions-page" class="hidden">
        <div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8 pb-24">
            <button id="back-to-counter-btn" class="mb-6 bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg shadow flex items-center transition-all">
                <i data-lucide="arrow-left" class="mr-2 h-5 w-5"></i>
                返回計數系統
            </button>
            
            <div class="instructions-content">
                <h2>8. 產生統計分析 (新功能)</h2>
                <p>除了匯出原始數據，系統還能自動產生該月份的統計圖表與 AI 分析建議：</p>
                <ol>
                    <li>點擊底部綠色(<span class="inline-flex items-center"><i data-lucide="pie-chart" class="h-4 w-4 inline-block mx-1 text-teal-600"></i></span>)的「**統計分析**」按鈕。</li>
                    <li>在跳出的視窗中，使用「**選擇月份**」欄位選擇您想分析的月份。</li>
                    <li>點擊「**產生分析**」按鈕。</li>
                    <li>系統會彈出一個新的「**月度統計分析報告**」視窗，此視窗包含兩個分頁：
                        <ul>
                            <li>**數據報表 (分頁 1)**：
                                <ul>
                                    <li>院區收送總覽：顯示該月永康和柳營院區的「總送件」、「總收件」統計。</li>
                                    <li>單位明細：以**分院區彙總表格**顯示各單位在該月的總送件與總收件數。</li>
                                    <li>AI 建議：系統自動提供的流程優化建議。</li>
                                </ul>
                            </li>
                            <li>**視覺化圖表 (分頁 2)**：
                                <ul>
                                    <li>**年度趨勢圖**：顯示該年度（1月至12月）各院區收送件的曲線圖。</li>
                                    <li>**院區佔比圖**：顯示該月份永康與柳營的總件數環圈圖。</li>
                                    <li>**TOP 10 單位圖**：顯示該月份郵件量前 10 名的單位橫條圖。</li>
                                </ul>
                            </li>
                        </ul>
                    </li>
                </ol>

                <h2>9. 清空本日資料 (請謹慎使用)</h2>
                <h2>10. 系統載入與異常排除</h2>
                </div>
        </div>
    </div>
    <div id="analysis-results-modal" class="fixed inset-0 bg-gray-600 bg-opacity-75 flex items-center justify-center z-50 hidden p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-6xl w-full max-h-[90vh] flex flex-col"> <div class="flex items-center justify-between pb-3 border-b">
                <div class="flex items-center">
                    <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-teal-100 sm:mx-0 sm:h-10 sm:w-10">
                        <i data-lucide="pie-chart" class="h-6 w-6 text-teal-600"></i>
                    </div>
                    <h3 id="analysis-results-title" class="ml-3 text-lg leading-6 font-medium text-gray-900">
                        月度統計分析報告
                    </h3>
                </div>
                <button id="close-analysis-results" type="button" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="h-6 w-6"></i>
                </button>
            </div>
            
            <div id="analysis-loading" class="flex flex-col items-center justify-center py-12">
                <i data-lucide="loader-2" class="h-12 w-12 text-teal-600 animate-spin"></i>
                <p class="mt-4 text-gray-600">正在產生分析報告，請稍候...</p>
            </div>

            <div id="analysis-content" class="mt-4 overflow-y-auto hidden space-y-6">
                
                <div class="flex items-center space-x-2 border-b-2 pb-2">
                    <button id="tab-btn-report" class="analysis-tab active">
                        <i data-lucide="file-text" class="inline-block h-4 w-4 mr-1"></i>
                        數據報表
                    </button>
                    <button id="tab-btn-chart" class="analysis-tab">
                        <i data-lucide="bar-chart-3" class="inline-block h-4 w-4 mr-1"></i>
                        視覺化圖表
                    </button>
                </div>
                
                <div id="data-report-content">
                    <div id="analysis-section-1">
                        <h4 class="text-xl font-semibold text-gray-800 mb-3">1. 院區收送總覽 (本月)</h4>
                        </div>
                    <div id="analysis-section-2" class="mt-6">
                        <h4 class="text-xl font-semibold text-gray-800 mb-3">2. 單位總收送件數彙總 (本月)</h4>
                        </div>
                    <div id="analysis-section-3" class="mt-6">
                        <h4 class="text-xl font-semibold text-gray-800 mb-3">3. AI 建議 (基於本月)</h4>
                        <div id="ai-suggestion-loading" class="flex items-center text-gray-500">
                            <i data-lucide="loader-2" class="h-5 w-5 mr-2 animate-spin"></i>
                            AI 正在分析數據並產生建議...
                        </div>
                        <div id="ai-suggestion-content" class="text-gray-700 max-w-none">
                            </div>
                    </div>
                </div>

                <div id="chart-visualization-content" class="hidden">
                    
                    <div class="mb-8 p-4 bg-white rounded-lg shadow">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">年度院區收送件趨勢 (全年度)</h4>
                        <div id="chart-monthly-trend" class="chart-container"></div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                        <div class="p-4 bg-white rounded-lg shadow">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4">院區總量佔比 (本月)</h4>
                            <div id="chart-campus-donut" class="chart-container flex items-center justify-center"></div>
                        </div>
                        <div class="p-4 bg-white rounded-lg shadow">
                            <h4 class="text-xl font-semibold text-gray-800 mb-4">Top 10 單位郵件量 (本月)</h4>
                            <div id="chart-top-units" class="chart-container"></div>
                        </div>
                    </div>
                    
                    <div class="mb-8 p-4 bg-white rounded-lg shadow">
                        <h4 class="text-xl font-semibold text-gray-800 mb-4">總送件 vs 總收件 (本月)</h4>
                        <div id="chart-send-receive" class="chart-container flex items-center justify-center"></div>
                    </div>

                </div>

            </div>

            <div class="mt-6 pt-4 border-t flex justify-end">
                <button id="close-analysis-results-bottom" type="button" class="bg-white hover:bg-gray-50 border border-gray-300 rounded-md shadow-sm py-2 px-4 text-sm font-medium text-gray-700">
                    關閉
                </button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@latest/dist/lucide.min.js"></script>

    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import {
            getAuth,
            signInAnonymously,
            onAuthStateChanged,
            signInWithCustomToken
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import {
            getFirestore,
            doc,
            getDoc,
            setDoc,
            onSnapshot,
            setLogLevel
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- 0. Firebase 設定與初始化 ---
        console.log("腳本開始執行...");

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        console.log("App ID:", appId);
        const firebaseConfigString = typeof __firebase_config !== 'undefined' ? __firebase_config : null;
        let firebaseConfig = null;

        // 您提供的 Firebase 配置
        const USER_PROVIDED_FIREBASE_CONFIG = {
            apiKey: "AIzaSyDSG0XE2D1Kdptlxl9oD7QPom3fupB6OHQ",
            authDomain: "base-9b8b4.firebaseapp.com",
            projectId: "base-9b8b4",
            storageBucket: "base-9b8b4.firebasestorage.app",
            messagingSenderId: "865059635319",
            appId: "1:865059635319:web:20cd2aee4ea7d9f5288672",
            measurementId: "G-YSW55LRG47"
        };


        // 1. 嘗試使用平台注入的配置 (如果存在且有效)
        if (firebaseConfigString && firebaseConfigString !== 'null') {
            console.log("正在解析 __firebase_config (自平台注入)...");
            try {
                const platformConfig = JSON.parse(firebaseConfigString);
                if (platformConfig && platformConfig.apiKey && platformConfig.projectId) {
                    firebaseConfig = platformConfig;
                    console.log("Firebase 設定載入成功 (使用平台注入配置)");
                }
            } catch (e) {
                console.warn("解析平台配置失敗，將使用使用者提供配置。", e);
            }
        } 
        
        // 2. 如果平台配置無效或不存在，使用使用者提供的配置
        if (!firebaseConfig) {
             console.log("使用使用者提供的配置。");
             firebaseConfig = USER_PROVIDED_FIREBASE_CONFIG;
        }


        let app;
        let auth;
        let db;
        if (firebaseConfig && firebaseConfig.apiKey && firebaseConfig.projectId) {
            try {
                console.log("正在初始化 Firebase Core/Auth/Firestore...");
                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
                // setLogLevel('Debug');
                console.log("Firebase 初始化成功 (物件建立)");
            } catch (error) {
                console.error("Firebase 初始化失敗:", error);
                displayError("【錯誤 002】無法初始化資料庫連線，請檢查 Firebase 設定或網路連線。錯誤：" + error.message);
                app = null;
                auth = null;
                db = null;
            }
        } else {
            displayError("【錯誤 003】缺少有效的 Firebase 設定 (apiKey 或 projectId 遺失)，無法繼續。");
            app = null;
            auth = null;
            db = null;
        }

        let dbRef = null;
        let userId = null;
        let unsubscribeSnapshot = null;
        let isDataLoaded = false;
        let isDataDirty = false;

        // --- 1. 系統常數 ---
        const SHIFTS = [
            { id: 'S1', type: '送件', time: '08:15', route: '佳里→永康', campus: '永康' }, // ADDED campus field
            { id: 'S2', type: '送件', time: '12:15', route: '佳里→永康', campus: '永康' }, // ADDED campus field
            { id: 'S3', type: '送件', time: '13:00', route: '佳里→柳營', campus: '柳營' }, // ADDED campus field
            { id: 'S4', type: '送件', time: '15:15', route: '佳里→永康', campus: '永康' }, // ADDED campus field
            { id: 'R1', type: '收件', time: '10:00', route: '永康→佳里', campus: '永康' }, // ADDED campus field
            { id: 'R2', type: '收件', time: '13:00', route: '柳營→佳里', campus: '柳營' }, // ADDED campus field
            { id: 'R3', type: '收件', time: '14:00', route: '永康→佳里', campus: '永康' }, // ADDED campus field
        ];
        
        const DEFAULT_DEPARTMENTS = [
            { id: 'D01', name: '院長室' }, { id: 'D02', name: '企劃組' }, { id: 'D03', name: '公共事務室' },
            { id: 'D04', name: '人力資源部' }, { id: 'D05', name: '醫療事務室' }, { id: 'D06', name: '醫療事務室-醫療服務' },
            { id: 'D07', name: '醫療事務室-住院服務' }, { id: 'D08', name: '醫療事務室-申報業務' }, { id: 'D09', name: '病歷資訊管理室' },
            { id: 'D10', name: '資訊室' }, { id: 'D11', name: '總務室(含出納組)' }, { id: 'D12', name: '社會服務部' },
            { id: 'D13', name: '安全衛生管理室' }, { id: 'D14', name: '工務室(含醫工組)' }, { id: 'D15', name: '資材室-採購組' },
            { id: 'D16', name: '資材室-補給組' }, { id: 'D17', name: '資材室-財產管理組' }, { id: 'D18', name: '護理部' },
            { id: 'D19', name: '輸送小組' }, { id: 'D20', name: '血液透析室' }, { id: 'D21', name: '居家服務中心' },
            { id: 'D22', name: '急診' }, { id: 'D23', name: '門診' }, { id: 'D24', name: '開刀房' },
            { id: 'D25', name: '加護病房' }, { id: 'D26', name: '呼吸照護病房' }, { id: 'D27', name: '專科護理師-內科' },
            { id: 'D28', name: '專科護理師-外科' }, { id: 'D29', name: '專科護理師-加護' }, { id: 'D30', name: '專科護理師-急診' },
            { id: 'D31', name: '復健科(含兒聯評)' }, { id: 'D32', name: '放射診斷科' }, { id: 'D33', name: '檢驗科' },
            { id: 'D34', name: '藥劑科' }, { id: 'D35', name: '營養科' }, { id: 'D36', name: '內科部' },
            { id: 'D37', name: '檢查室' }, { id: 'D38', name: '外科部' }, { id: 'D39', name: '社區發展組(含癌篩)' },
            { id: 'D40', name: '牙科部' }, { id: 'D41', name: '麻醉科' }, { id: 'D42', name: '呼吸治療組' },
            { id: 'D43', name: '圖書館' }, { id: 'D44', name: '教學研究組' }, { id: 'D45', name: '感染管制組' },
            { id: 'D46', name: '品質管理中心' }, { id: 'D47', name: '居家護理所' }, { id: 'D48', name: '醫美門診' },
            { id: 'D49', name: '心導管室' }, { id: 'DYN_ADD', name: '新增單位...' },
        ];

        // --- 2. 應用程式狀態 ---
        let state = {
            currentDate: '',
            activeShiftId: SHIFTS[0].id,
            isEditMode: false,
            currentPage: 'counter', // 追蹤目前頁面
        };

        let dataFromFirestore = {
            counts: {},
            departments: [...DEFAULT_DEPARTMENTS],
            layoutOrder: DEFAULT_DEPARTMENTS.map(d => d.id)
        };

        let sortableInstance = null;
        
        // 全局圖表實例
        let chartMonthlyTrend = null;
        let chartCampusDonut = null;
        let chartTopUnits = null;
        let chartSendReceive = null;

        // *** MODIFICATION: 將所有 DOM 變數宣告移到這裡，設為 let ***
        let shiftTabsContainer, departmentGrid, dateInput, shiftTotalEl, dayTotalEl,
            toggleEditBtn, editLayoutText, exportBtn, resetBtn, resetModal,
            cancelResetBtn, confirmResetBtn, resetDateDisplay,
            exportReportModalBtn, reportDownloadModal, cancelReportDownloadBtn,
            confirmReportDownloadBtn, reportPeriodInput, reportPeriodLabel,
            reportDownloadError, reportTypeMonth, reportTypeYear,
            addDeptModal, cancelAddDeptBtn, confirmAddDeptBtn, newDeptNameInput,
            addDeptError, saveDataBtn, saveDataText, loadingIndicator, errorMessageDiv,
            showInstructionsBtn, instructionsPage, counterPage, backToCounterBtn,
            showAnalysisModalBtn, analysisModal, cancelAnalysisModalBtn,
            confirmGenerateAnalysisBtn, analysisMonthInput, analysisModalError,
            analysisResultsModal, closeAnalysisResultsBtn, closeAnalysisResultsBottomBtn,
            analysisLoading, analysisContent, analysisResultsTitle,
            tabBtnReport, tabBtnChart, dataReportContent, chartVisualizationContent,
            analysisSection1, analysisSection2, analysisSection3,
            aiSuggestionLoading, aiSuggestionContent,
            chartMonthlyTrendDiv, chartCampusDonutDiv, chartTopUnitsDiv, chartSendReceiveDiv;


        // --- 4. 資料處理函式 (Firebase Firestore) ---
        // ... (saveDataToFirestore, updateSaveButtonState, getFormattedDate, getCountsForDate, getCount, setCount - 內容不變) ...
        async function saveDataToFirestore() {
            console.log("saveDataToFirestore 函數被呼叫");
            if (!dbRef || !isDataLoaded) {
                console.log("Firestore 尚未準備好或資料未載入，儲存動作已暫停。 dbRef:", dbRef, "isDataLoaded:", isDataLoaded);
                displayError("無法儲存，資料尚未完全載入或連線失敗。");
                return;
            }

            saveDataBtn.disabled = true;
            saveDataBtn.innerHTML = `<i data-lucide="loader-2" class="mr-2 h-5 w-5 animate-spin"></i> <span>儲存中...</span>`;
            if (typeof lucide !== 'undefined') lucide.createIcons();

            console.log("正在 (手動) 儲存資料到 Firestore...", dataFromFirestore);
            try {
                await setDoc(dbRef, dataFromFirestore, { merge: true });
                console.log("資料儲存成功。");
                isDataDirty = false;
                updateSaveButtonState();
            } catch (error) {
                console.error("儲存到 Firestore 時發生錯誤:", error);
                saveDataBtn.disabled = false;
                saveDataBtn.innerHTML = `<i data-lucide="alert-triangle" class="mr-2 h-5 w-5"></i> <span>儲存失敗</span>`;
                if (typeof lucide !== 'undefined') lucide.createIcons();
                displayError("儲存資料失敗，請稍後再試。錯誤：" + error.message);
            }
        }

        function updateSaveButtonState() {
            const icon = saveDataBtn.querySelector('i');
            if (!icon) return;

            if (isDataDirty) {
                saveDataBtn.disabled = false;
                saveDataBtn.classList.remove('bg-gray-400');
                saveDataBtn.classList.add('bg-purple-600', 'hover:bg-purple-700');
                saveDataText.textContent = '儲存變更';
                icon.setAttribute('data-lucide', 'save');
            } else {
                saveDataBtn.disabled = true;
                saveDataBtn.classList.add('bg-gray-400');
                saveDataBtn.classList.remove('bg-purple-600', 'hover:bg-purple-700');
                saveDataText.textContent = '已儲存';
                icon.setAttribute('data-lucide', 'check');
            }
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function getFormattedDate(date) {
            return date.toISOString().split('T')[0];
        }

        function getCountsForDate(date) {
            if (!dataFromFirestore.counts[date]) {
                dataFromFirestore.counts[date] = {};
            }
            return dataFromFirestore.counts[date];
        }

        function getCount(date, deptId, shiftId) {
            const dateData = getCountsForDate(date);
            if (!dateData[deptId]) {
                dateData[deptId] = {};
            }
            return dateData[deptId][shiftId] || 0;
        }

        function setCount(date, deptId, shiftId, count) {
            const dateData = getCountsForDate(date);
            if (!dateData[deptId]) {
                dateData[deptId] = {};
            }
            if (count > 0) {
                dateData[deptId][shiftId] = count;
            } else {
                delete dateData[deptId][shiftId];
                if (Object.keys(dateData[deptId]).length === 0) {
                    delete dateData[deptId];
                }
            }
            isDataDirty = true;
            updateSaveButtonState();
        }

        // --- 5. 頁面導覽函式 ---
        // ... (navigateTo 內容不變) ...
        function navigateTo(pageName) {
            state.currentPage = pageName;
            console.log(`導覽至: ${pageName}`);
            if (pageName === 'counter') {
                counterPage.classList.remove('hidden');
                instructionsPage.classList.add('hidden');
            } else if (pageName === 'instructions') {
                counterPage.classList.add('hidden');
                instructionsPage.classList.remove('hidden');
                // 確保說明頁面的 lucide 圖示被渲染
                // 使用 try-catch 增加 robustness
                if (typeof lucide !== 'undefined' && lucide.createIcons) {
                    try {
                        lucide.createIcons();
                    } catch (e) {
                        console.error("在說明頁面渲染 Lucide 圖示時出錯:", e);
                    }
                }
            }
        }

        // --- 6. 渲染函式 (Render) ---
        // ... (renderShiftTabs, renderDepartmentGrid, updateButtonCount, updateTotals - 內容不變) ...
        function renderShiftTabs() {
            if (!shiftTabsContainer) {
                console.error("找不到 shift-tabs-container 元素！");
                return;
            }
            shiftTabsContainer.innerHTML = '';
            SHIFTS.forEach(shift => {
                const tab = document.createElement('button');
                tab.className = `shift-tab py-4 px-5 text-sm font-medium text-gray-500 hover:text-gray-700 ${shift.id === state.activeShiftId ? 'active' : ''}`;
                tab.dataset.shiftId = shift.id;

                const typeColor = shift.type === '送件' ? 'text-blue-600' : 'text-green-600';
                tab.innerHTML = `
                    <span class="font-bold ${typeColor}">[${shift.type}]</span>
                    <span class="ml-2">${shift.time}</span>
                    <span class="ml-1 text-xs text-gray-400">(${shift.route})</span>
                `;

                tab.addEventListener('click', () => {
                    console.log(`班次切換至: ${shift.id}`);
                    state.activeShiftId = shift.id;
                    renderShiftTabs();
                    renderDepartmentGrid();
                    updateTotals();
                });
                shiftTabsContainer.appendChild(tab);
            });
        }

        function renderDepartmentGrid() {
            console.log("渲染單位網格...");
            if (!departmentGrid || !loadingIndicator || !errorMessageDiv) {
                console.error("找不到 department-grid, loading-indicator 或 error-message 元素！");
                displayError("頁面元件遺失，無法正常顯示單位列表。");
                return;
            }
            departmentGrid.innerHTML = '';
            const date = state.currentDate;
            console.log(`使用日期 ${date} 的資料渲染單位網格`);

            if (!dataFromFirestore || !dataFromFirestore.layoutOrder || !dataFromFirestore.departments) {
                console.error("缺少 layoutOrder 或 departments 資料，無法渲染網格。");
                displayError("單位資料遺失，無法顯示列表。");
                return;
            }

            dataFromFirestore.layoutOrder.forEach(deptId => {
                const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                if (!dept) {
                    return;
                }

                if (dept.id === 'DYN_ADD') {
                    const button = document.createElement('button');
                    button.className = 'dept-btn bg-green-50 hover:bg-green-100 border-2 border-green-300 border-dashed rounded-lg p-3 text-center transition-all h-20 flex items-center justify-center text-green-600 font-medium';
                    button.innerHTML = `<i data-lucide="plus" class="mr-2 h-5 w-5"></i> ${dept.name}`;
                    button.addEventListener('click', () => {
                        if (state.isEditMode) return;
                        showAddDeptModal();
                    });
                    departmentGrid.appendChild(button);
                    return;
                }

                const count = getCount(date, dept.id, state.activeShiftId);
                const button = document.createElement('button');
                button.className = 'dept-btn bg-white rounded-lg p-3 text-center transition-all h-20 flex items-center justify-center';
                button.dataset.deptId = dept.id;
                button.innerHTML = `
                    <span class="text-sm font-medium text-gray-800 leading-tight">${dept.name}</span>
                    <div class="count-badge ${count > 0 ? 'visible' : ''}">
                        ${count}
                    </div>
                `;

                button.addEventListener('click', () => {
                    if (state.isEditMode) return;
                    const newCount = getCount(date, dept.id, state.activeShiftId) + 1;
                    setCount(date, dept.id, state.activeShiftId, newCount);
                    updateButtonCount(button, newCount);
                    updateTotals();
                });

                button.addEventListener('contextmenu', (e) => {
                    e.preventDefault();
                    if (state.isEditMode) return;
                    let currentCount = getCount(date, dept.id, state.activeShiftId);
                    if (currentCount > 0) {
                        const newCount = currentCount - 1;
                        setCount(date, dept.id, state.activeShiftId, newCount);
                        updateButtonCount(button, newCount);
                        updateTotals();
                    }
                });
                departmentGrid.appendChild(button);
            });

            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try {
                    lucide.createIcons();
                } catch (e) {
                    console.error("渲染 Lucide 圖示時出錯:", e);
                }
            } else {
                console.warn("Lucide library 未載入或 createIcons 方法不存在");
            }

            loadingIndicator.style.display = 'none';
            errorMessageDiv.style.display = 'none';
            departmentGrid.classList.remove('hidden');
            console.log("單位網格渲染完成");
        }

        function updateButtonCount(button, count) {
            const badge = button.querySelector('.count-badge');
            if (!badge) return;
            badge.textContent = count;
            if (count > 0) {
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }
        }

        function updateTotals() {
            const date = state.currentDate;
            const dateData = getCountsForDate(date);
            let shiftTotal = 0;
            let dayTotal = 0;

            Object.values(dateData).forEach(deptShifts => {
                Object.entries(deptShifts).forEach(([shiftId, count]) => {
                    if (shiftId === state.activeShiftId) {
                        shiftTotal += count;
                    }
                    dayTotal += (typeof count === 'number' ? count : 0);
                });
            });

            if (shiftTotalEl) shiftTotalEl.textContent = shiftTotal;
            if (dayTotalEl) dayTotalEl.textContent = dayTotal;
        }

        // --- 7. 拖曳排序功能 ---
        // ... (initSortable, toggleEditMode - 內容不變) ...
        function initSortable() {
            console.log("初始化 Sortable...");
            if (!departmentGrid) {
                console.error("無法初始化 Sortable：找不到 department-grid 元素。");
                return;
            }
            if (typeof Sortable === 'undefined') {
                console.error("Sortable library 未載入！");
                displayError("頁面排序功能載入失敗。");
                return;
            }
            try {
                sortableInstance = new Sortable(departmentGrid, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    chosenClass: 'sortable-chosen',
                    disabled: !state.isEditMode,
                    filter: '.dept-btn:last-child', // DYN_ADD 永遠是最後一個
                    onEnd: (evt) => {
                        console.log("拖曳結束，更新順序...");
                        const movedItem = dataFromFirestore.layoutOrder.splice(evt.oldIndex, 1)[0];
                        dataFromFirestore.layoutOrder.splice(evt.newIndex, 0, movedItem);
                        console.log("新順序:", dataFromFirestore.layoutOrder);
                        isDataDirty = true;
                        updateSaveButtonState();
                    }
                });
                console.log("Sortable 初始化成功");
            } catch(error) {
                console.error("初始化 Sortable 失敗:", error);
                displayError("初始化頁面排序功能時出錯：" + error.message);
            }
        }

        function toggleEditMode() {
            if (!sortableInstance) {
                console.warn("Sortable 未初始化，無法切換編輯模式。");
                return;
            }

            state.isEditMode = !state.isEditMode;
            console.log(`切換編輯模式: ${state.isEditMode}`);
            sortableInstance.option('disabled', !state.isEditMode);

            const icon = toggleEditBtn.querySelector('i');
            if (!icon) return;

            if (state.isEditMode) {
                departmentGrid.classList.add('editing-layout');
                editLayoutText.textContent = '儲存順序';
                toggleEditBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                toggleEditBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                icon.setAttribute('data-lucide', 'save');
            } else {
                departmentGrid.classList.remove('editing-layout');
                editLayoutText.textContent = '編輯順序';
                toggleEditBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
                toggleEditBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                icon.setAttribute('data-lucide', 'move');
            }

            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try {
                    lucide.createIcons();
                } catch(e) { console.error("重繪 Lucide 圖示失敗:", e); }
            }
        }


        // --- 8. Excel 匯出功能 ---
        // ... (exportToExcel, exportSelectedReport - 內容不變) ...
        function exportToExcel() {
            console.log("匯出本日 Excel...");
            if (typeof XLSX === 'undefined') {
                console.error("XLSX library 未載入！");
                displayError("無法匯出 Excel，所需元件載入失敗。");
                return;
            }
            const date = state.currentDate;
            const twDate = new Date(date);
            const twYear = twDate.getFullYear() - 1911;
            const twMonth = twDate.getMonth() + 1;
            const twDay = twDate.getDate();
            const title = `佳里奇美醫院 院內郵差件數統計表`;
            const dateString = `日期： ${twYear}年${twMonth}月${twDay}日`;

            const header1 = ["", "送件", "", "", "", "收件", "", "", ""];
            const header2 = ["班別", "08:15", "12:15", "13:00", "15:15", "10:00", "13:00", "14:00", "合計件數"];
            const header3 = ["", "佳里→永康", "佳里→永康", "佳里→柳營", "佳里→永康", "永康→佳里", "柳營→佳里", "永康→佳里", ""];

            let data = [
                [title],
                [dateString],
                header1,
                header2,
                header3
            ];

            const colTotals = Array(SHIFTS.length).fill(0);
            let grandTotal = 0;

            dataFromFirestore.layoutOrder.forEach(deptId => {
                const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                if (!dept || dept.id === 'DYN_ADD') return;

                let rowTotal = 0;
                const row = [dept.name];

                SHIFTS.forEach((shift, index) => {
                    const count = getCount(date, dept.id, shift.id);
                    row.push(count > 0 ? count : "");
                    rowTotal += count;
                    colTotals[index] += count;
                });

                row.push(rowTotal > 0 ? rowTotal : "");
                grandTotal += rowTotal;
                data.push(row);
            });

            const footerRow = ["合計件數"];
            colTotals.forEach(total => {
                footerRow.push(total > 0 ? total : "");
            });
            footerRow.push(grandTotal > 0 ? grandTotal : "");
            data.push(footerRow);

            try {
                const ws = XLSX.utils.aoa_to_sheet(data);
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
                    { s: { r: 2, c: 1 }, e: { r: 2, c: 4 } },
                    { s: { r: 2, c: 5 }, e: { r: 2, c: 7 } },
                ];
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "郵件計數");
                const fileName = `院內郵件計數_${date}.xlsx`;
                XLSX.writeFile(wb, fileName);
                console.log("Excel 匯出成功:", fileName);
            } catch (error) {
                console.error("匯出 Excel 失敗:", error);
                displayError("匯出 Excel 檔案時發生錯誤：" + error.message);
            }
        }
        
        function exportSelectedReport(period, type) {
            console.log(`匯出報表: ${type}, 期間: ${period}...`);
            if (typeof XLSX === 'undefined') {
                console.error("XLSX library 未載入！");
                displayError("無法匯出 Excel，所需元件載入失敗。");
                return;
            }

            const wb = XLSX.utils.book_new();
            let summaryData = {};
            let summaryColTotals = Array(SHIFTS.length).fill(0);
            let summaryGrandTotal = 0;
            
            const twYearBase = type === 'month' ? period.split('-')[0] : period;
            const twYear = parseInt(twYearBase, 10) - 1911;
            const allDates = Object.keys(dataFromFirestore.counts);

            // 確定要處理的日期範圍
            const relevantDates = allDates
                .filter(date => date.startsWith(period))
                .sort();
            
            if (relevantDates.length === 0) {
                reportDownloadError.textContent = `這個 ${type === 'month' ? '月' : '年'} 份沒有資料可匯出。`;
                reportDownloadError.classList.remove('hidden');
                console.warn(`${period} 沒有資料可匯出`);
                return;
            }
            reportDownloadError.classList.add('hidden');

            try {
                // 1. 彙總數據計算
                relevantDates.forEach(date => {
                    const dateData = dataFromFirestore.counts[date];
                    if (!dateData) return;
                    dataFromFirestore.departments.forEach(dept => {
                        if (dept.id === 'DYN_ADD') return;
                        if (!summaryData[dept.id]) summaryData[dept.id] = {};
                        SHIFTS.forEach((shift) => {
                            const count = getCount(date, dept.id, shift.id);
                            if (count > 0) {
                                if (!summaryData[dept.id][shift.id]) summaryData[dept.id][shift.id] = 0;
                                summaryData[dept.id][shift.id] += count;
                            }
                        });
                    });
                });

                // 2. 彙總報表工作表 (月報表/年報表皆有)
                const header1 = ["", "送件", "", "", "", "收件", "", "", ""];
                const header2 = ["班別", "08:15", "12:15", "13:00", "15:15", "10:00", "13:00", "14:00", "合計件數"];
                const header3 = ["", "佳里→永康", "佳里→永康", "佳里→柳營", "佳里→永康", "永康→佳里", "柳營→佳里", "永康→佳里", ""];

                const reportTitle = type === 'month' ? "佳里奇美醫院 院內郵差月統計表" : "佳里奇美醫院 院內郵差年統計表";
                const dateHeader = type === 'month' 
                    ? `月份： ${twYear}年${parseInt(period.split('-')[1], 10)}月` 
                    : `年份： ${twYear}年`;

                let summaryAOA = [
                    [reportTitle],
                    [dateHeader],
                    header1, header2, header3
                ];

                dataFromFirestore.layoutOrder.forEach(deptId => {
                    const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                    if (!dept || dept.id === 'DYN_ADD') return;

                    let rowTotal = 0;
                    const row = [dept.name];
                    const deptData = summaryData[dept.id] || {};

                    SHIFTS.forEach((shift, index) => {
                        const count = deptData[shift.id] || 0;
                        row.push(count > 0 ? count : "");
                        rowTotal += count;
                        summaryColTotals[index] += count;
                    });

                    row.push(rowTotal > 0 ? rowTotal : "");
                    summaryGrandTotal += rowTotal;
                    summaryAOA.push(row);
                });

                const summaryFooterRow = ["合計件數"];
                summaryColTotals.forEach(total => {
                    summaryFooterRow.push(total > 0 ? total : "");
                });
                summaryFooterRow.push(summaryGrandTotal > 0 ? summaryGrandTotal : "");
                summaryAOA.push(summaryFooterRow);

                const wsSummary = XLSX.utils.aoa_to_sheet(summaryAOA);
                wsSummary['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
                    { s: { r: 2, c: 1 }, e: { r: 2, c: 4 } },
                    { s: { r: 2, c: 5 }, e: { r: 2, c: 7 } },
                ];
                XLSX.utils.book_append_sheet(wb, wsSummary, type === 'month' ? "月份統計" : "年度彙總");

                // 3. 每日明細工作表 (僅限月報表)
                if (type === 'month') {
                    const dailyHeader1 = ["", "送件", "", "", "", "收件", "", "", ""];
                    const dailyHeader2 = ["班別", "08:15", "12:15", "13:00", "15:15", "10:00", "13:00", "14:00", "合計件數"];
                    const dailyHeader3 = ["", "佳里→永康", "佳里→永康", "佳里→柳營", "佳里→永康", "永康→佳里", "柳營→佳里", "永康→佳里", ""];

                    relevantDates.forEach(date => {
                        const dateData = dataFromFirestore.counts[date];
                        if (!dateData || Object.keys(dateData).length === 0) {
                            return;
                        }

                        const twDate = new Date(date);
                        const twYearDay = twDate.getFullYear() - 1911;
                        const twMonthDay = twDate.getMonth() + 1;
                        const twDay = twDate.getDate();
                        const dailyTitle = `佳里奇美醫院 院內郵差件數統計表`;
                        const dailyDateString = `日期： ${twYearDay}年${twMonthDay}月${twDay}日`;

                        let dailyAOA = [
                            [dailyTitle],
                            [dailyDateString],
                            dailyHeader1,
                            dailyHeader2,
                            dailyHeader3
                        ];

                        const colTotals = Array(SHIFTS.length).fill(0);
                        let grandTotal = 0;
                        let hasDataForThisDay = false;

                        dataFromFirestore.layoutOrder.forEach(deptId => {
                            const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                            if (!dept || dept.id === 'DYN_ADD') return;

                            let rowTotal = 0;
                            const row = [dept.name];

                            SHIFTS.forEach((shift, index) => {
                                const count = getCount(date, dept.id, shift.id);
                                row.push(count > 0 ? count : "");
                                rowTotal += count;
                                colTotals[index] += count;
                            });

                            row.push(rowTotal > 0 ? rowTotal : "");
                            grandTotal += rowTotal;
                            dailyAOA.push(row);
                            if (rowTotal > 0) {
                                hasDataForThisDay = true;
                            }
                        });

                        if (hasDataForThisDay) {
                            const footerRow = ["合計件數"];
                            colTotals.forEach(total => {
                                footerRow.push(total > 0 ? total : "");
                            });
                            footerRow.push(grandTotal > 0 ? grandTotal : "");
                            dailyAOA.push(footerRow);

                            const wsDaily = XLSX.utils.aoa_to_sheet(dailyAOA);
                            wsDaily['!merges'] = [
                                { s: { r: 0, c: 0 }, e: { r: 0, c: 8 } },
                                { s: { r: 1, c: 0 }, e: { r: 1, c: 8 } },
                                { s: { r: 2, c: 1 }, e: { r: 2, c: 4 } },
                                { s: { r: 2, c: 5 }, e: { r: 2, c: 7 } },
                            ];
                            const sheetName = date.substring(5).replace('-', '.');
                            XLSX.utils.book_append_sheet(wb, wsDaily, sheetName);
                        }
                    });
                }
                
                // 4. 寫入檔案
                const fileName = type === 'month' ? `院內郵件月報表_${period}.xlsx` : `院內郵件年報表_${period}.xlsx`;
                XLSX.writeFile(wb, fileName);
                console.log("報表匯出成功:", fileName);
                hideReportDownloadModal();

            } catch (error) {
                console.error("匯出報表失敗:", error);
                displayError("匯出 Excel 報表時發生錯誤：" + error.message);
                hideReportDownloadModal();
            }
        }
        
        // --- 9. AI 分析功能 (已修改) ---
        
        /**
         * 呼叫 Gemini API (已修正 API Key 和模型)
         * @param {string} prompt - 傳送給 AI 的提示詞
         * @param {number} retries - 重試次數
         * @param {number} delay - 初始重試延遲 (ms)
         * @returns {Promise<string>} - AI 回應的文字
         */
        async function callGeminiAPI(prompt, retries = 3, delay = 1000) {
            console.log("正在呼叫 Gemini API...");

            // --- 
            // *** MODIFICATION: 請在此處貼上您的 Google AI Studio API 金鑰 ***
            // 1. 前往 https://aistudio.google.com/app/apikey
            // 2. 建立並複製您的 API 金鑰
            // 3. 將金鑰貼在引號之間 (例如: "AIzaSy...")
            // ---
            const apiKey = "在這裡貼上您剛才複製的_GOOGLE_AI_STUDIO_API_KEY"; // <--- ！！請務必替換此行！！
            
            // 檢查金鑰是否存在
            if (apiKey === "在這裡貼上您剛才複製的_GOOGLE_AI_STUDIO_API_KEY" || apiKey === "") {
                console.error("AI 分析失敗：未提供 Google AI Studio API 金鑰。");
                return "AI 分析失敗：未設定 API 金鑰。請檢查 `callGeminiAPI` 函式中的 `apiKey` 變數。";
            }

            // MODIFICATION: 更新為更穩定的模型名稱
            const modelName = "gemini-1.5-flash-latest"; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

            const systemPrompt = "你是一位專業的物流與行政效率分析師。請根據以下的院內郵件月度數據，提供簡潔、條理分明(使用條列式)的分析與建議，旨在優化郵件收送流程或指出潛在問題。你的分析應著重於：\n1. 永康和柳營院區的收送件量是否平衡？\n2. 哪些班次的負擔特別重？\n3. 哪些單位的使用量特別高或低，是否有異常？\n4. 基於這些數據，提出 2-3 點具體的改善建議。\n語言：繁體中文。";

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
                generationConfig: {
                    temperature: 0.5,
                    topK: 1,
                    topP: 1,
                    maxOutputTokens: 2048,
                }
            };

            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorBody = await response.json();
                        console.error(`Gemini API 錯誤 (HTTP ${response.status}):`, errorBody);
                        // 顯示更詳細的 API 錯誤訊息
                        if (errorBody.error && errorBody.error.message) {
                             throw new Error(`API 請求失敗: ${errorBody.error.message}`);
                        }
                        throw new Error(`API 請求失敗，狀態碼: ${response.status}`);
                    }

                    const result = await response.json();
                    console.log("Gemini API 原始回應:", result);

                    const candidate = result.candidates?.[0];
                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        console.log("Gemini API 分析成功。");
                        return candidate.content.parts[0].text;
                    } else {
                        // 檢查是否有安全阻擋
                        if (candidate && candidate.finishReason === 'SAFETY') {
                             console.warn("AI 回應被安全設定阻擋:", candidate.safetyRatings);
                             throw new Error("AI 回應因安全設定被阻擋。");
                        }
                        console.warn("Gemini API 回應中未找到有效的文字內容:", result);
                        throw new Error("無效的 API 回應結構。");
                    }
                } catch (error) {
                    console.error(`呼叫 Gemini API 失敗 (嘗試 ${i + 1}/${retries}):`, error.message);
                    if (i === retries - 1) {
                        // 最後一次嘗試失敗
                        return `AI 分析失敗：無法連接到分析服務或回應格式錯誤。請檢查網路連線或 API 金鑰設定。(${error.message})`;
                    }
                    // Exponential backoff
                    await new Promise(resolve => setTimeout(resolve, delay * Math.pow(2, i)));
                }
            }
            return "AI 分析失敗：已達最大重試次數。";
        }
        
        /**
         * *** MODIFICATION: 產生月度與年度分析數據 ***
         * @param {string} yearMonth - YYYY-MM 格式的月份
         * @returns {object | null} - 包含分析數據的物件，或在無資料時返回 null
         */
        function generateAnalysisData(yearMonth) {
            console.log(`正在為 ${yearMonth} 產生分析數據...`);
            
            const selectedYear = yearMonth.split('-')[0];
            const allDates = Object.keys(dataFromFirestore.counts);
            
            // 1. 抓取全年度的數據
            const relevantYearDates = allDates.filter(date => date.startsWith(selectedYear));
            if (relevantYearDates.length === 0) {
                console.warn(`年份 ${selectedYear} 沒有資料。`);
                return null;
            }

            // 初始化年度趨勢數據 (12 個月份)
            let monthlyTrendData = {
                yongkangSend: Array(12).fill(0),
                yongkangReceive: Array(12).fill(0),
                liuyingSend: Array(12).fill(0),
                liuyingReceive: Array(12).fill(0)
            };

            // 2. 抓取所選月份的數據
            const relevantMonthDates = relevantYearDates.filter(date => date.startsWith(yearMonth));

            // 初始化所選月份的數據
            let analysis = {
                yongkang: { send: 0, receive: 0, shifts: {} },
                liuying: { send: 0, receive: 0, shifts: {} }
            };
            let unitSummaryByCampus = { '永康': {}, '柳營': {} };
            
            // 初始化班次計數器 (for selected month)
            SHIFTS.forEach(shift => {
                if (shift.campus === '永康') {
                    analysis.yongkang.shifts[shift.id] = { name: `[${shift.type}] ${shift.time}`, count: 0 };
                }
                if (shift.campus === '柳營') {
                    analysis.liuying.shifts[shift.id] = { name: `[${shift.type}] ${shift.time}`, count: 0 };
                }
            });

            // 3. 遍歷全年度數據，計算趨勢
            relevantYearDates.forEach(date => {
                const dateData = dataFromFirestore.counts[date];
                if (!dateData) return;
                const monthIndex = parseInt(date.split('-')[1], 10) - 1; // 0 = 1月, 11 = 12月

                Object.keys(dateData).forEach(deptId => {
                    const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                    if (!dept || dept.id === 'DYN_ADD') return;
                    
                    Object.keys(dateData[deptId]).forEach(shiftId => {
                        const count = dateData[deptId][shiftId] || 0;
                        if (count === 0) return;

                        const shift = SHIFTS.find(s => s.id === shiftId);
                        if (!shift) return;
                        
                        const campus = shift.campus;
                        if (!campus) return;

                        // 填充年度趨勢數據
                        if (campus === '永康') {
                            if (shift.type === '送件') monthlyTrendData.yongkangSend[monthIndex] += count;
                            else monthlyTrendData.yongkangReceive[monthIndex] += count;
                        } else if (campus === '柳營') {
                            if (shift.type === '送件') monthlyTrendData.liuyingSend[monthIndex] += count;
                            else monthlyTrendData.liuyingReceive[monthIndex] += count;
                        }
                    });
                });
            });

            // 4. 遍歷所選月份數據，計算當月總覽和單位彙總
            if (relevantMonthDates.length > 0) {
                relevantMonthDates.forEach(date => {
                    const dateData = dataFromFirestore.counts[date];
                    if (!dateData) return;

                    Object.keys(dateData).forEach(deptId => {
                        const dept = dataFromFirestore.departments.find(d => d.id === deptId);
                        if (!dept || dept.id === 'DYN_ADD') return;
                        const deptName = dept.name;
                        
                        Object.keys(dateData[deptId]).forEach(shiftId => {
                            const count = dateData[deptId][shiftId] || 0;
                            if (count === 0) return;

                            const shift = SHIFTS.find(s => s.id === shiftId);
                            if (!shift) return;
                            
                            const campus = shift.campus;
                            if (!campus || !unitSummaryByCampus[campus]) return; // 安全檢查

                            if (!unitSummaryByCampus[campus][deptName]) {
                                unitSummaryByCampus[campus][deptName] = { totalSend: 0, totalReceive: 0 };
                            }
                            
                            // 總結單位收送件數 (本月)
                            if (shift.type === '送件') {
                                unitSummaryByCampus[campus][deptName].totalSend += count;
                            } else if (shift.type === '收件') {
                                unitSummaryByCampus[campus][deptName].totalReceive += count;
                            }

                            // 總結院區班次數據 (本月)
                            if (campus === '永康') {
                                if (shift.type === '送件') analysis.yongkang.send += count;
                                else analysis.yongkang.receive += count;
                                if(analysis.yongkang.shifts[shift.id]) analysis.yongkang.shifts[shift.id].count += count;
                            } else if (campus === '柳營') {
                                if (shift.type === '送件') analysis.liuying.send += count;
                                else analysis.liuying.receive += count;
                                if(analysis.liuying.shifts[shift.id]) analysis.liuying.shifts[shift.id].count += count;
                            }
                        });
                    });
                });
            } else {
                 console.warn(`所選月份 ${yearMonth} 沒有資料，但該年度有資料。`);
            }
            
            // 5. 準備 AI Prompt 用的 Top 10 數據 (基於本月)
            let allUnitsTotal = [];
            for (const campus in unitSummaryByCampus) {
                for (const unit in unitSummaryByCampus[campus]) {
                    const totals = unitSummaryByCampus[campus][unit];
                    allUnitsTotal.push({
                        unit: unit,
                        total: totals.totalSend + totals.totalReceive
                    });
                }
            }

            const topUnitsData = allUnitsTotal
                .sort((a, b) => b.total - a.total)
                .slice(0, 10)
                .filter(d => d.total > 0); // 只顯示大於 0 的
            
            const aiPrompt = `
月份: ${yearMonth}
數據摘要:
1. 院區總量:
    - 永康院區: 送件 ${analysis.yongkang.send} 件, 收件 ${analysis.yongkang.receive} 件
    - 柳營院區: 送件 ${analysis.liuying.send} 件, 收件 ${analysis.liuying.receive} 件
2. 永康院區-各班次件數:
${Object.values(analysis.yongkang.shifts).filter(s => s.count > 0).map(s => `    - ${s.name}: ${s.count} 件`).join('\n')}
3. 柳營院區-各班次件數:
${Object.values(analysis.liuying.shifts).filter(s => s.count > 0).map(s => `    - ${s.name}: ${s.count} 件`).join('\n')}
4. 本月郵件量前 10 名單位 (總送收件):
${topUnitsData.map(u => `    - ${u.unit}: ${u.total} 件`).join('\n')}
請基於以上數據提供分析與建議。
`;

            console.log("分析數據產生完畢:", { analysis, unitSummaryByCampus, aiPrompt, monthlyTrendData, topUnitsData });
            
            return { analysis, unitSummaryByCampus, aiPrompt, monthlyTrendData, topUnitsData };
        }
        
        /**
         * *** MODIFICATION: 渲染「數據報表」分頁 ***
         * @param {object} analysis - 院區總覽數據
         * @param {object} unitSummaryByCampus - 單位送件與收件總數彙總 (按院區分組)
         */
        function renderAnalysisReportTab(analysis, unitSummaryByCampus) {
            console.log("正在渲染「數據報表」分頁...");
            
            // --- 1. 渲染院區總覽 --- 
            let html1 = '<div class="grid grid-cols-1 md:grid-cols-2 gap-6">';
            
            // 永康
            html1 += '<div class="bg-gray-50 p-4 rounded-lg shadow-inner">';
            html1 += '<h5 class="text-lg font-semibold text-blue-700 mb-3">永康院區</h5>';
            html1 += `<p class="text-gray-700 mb-1"><strong>總送件:</strong> <span class="text-xl font-bold text-blue-600">${analysis.yongkang.send}</span> 件</p>`;
            html1 += `<p class="text-gray-700 mb-3"><strong>總收件:</strong> <span class="text-xl font-bold text-green-600">${analysis.yongkang.receive}</span> 件</p>`;
            html1 += '<h6 class="font-semibold text-gray-600 mb-2">各班次明細:</h6><ul class="list-disc list-inside space-y-1 text-sm">';
            Object.values(analysis.yongkang.shifts).forEach(shift => {
                if (shift.count > 0) html1 += `<li>${shift.name}: <span class="font-medium">${shift.count}</span> 件</li>`;
            });
            html1 += '</ul></div>';

            // 柳營
            html1 += '<div class="bg-gray-50 p-4 rounded-lg shadow-inner">';
            html1 += '<h5 class="text-lg font-semibold text-orange-700 mb-3">柳營院區</h5>';
            html1 += `<p class="text-gray-700 mb-1"><strong>總送件:</strong> <span class="text-xl font-bold text-blue-600">${analysis.liuying.send}</span> 件</p>`;
            html1 += `<p class="text-gray-700 mb-3"><strong>總收件:</strong> <span class="text-xl font-bold text-green-600">${analysis.liuying.receive}</span> 件</p>`;
            html1 += '<h6 class="font-semibold text-gray-600 mb-2">各班次明細:</h6><ul class="list-disc list-inside space-y-1 text-sm">';
            Object.values(analysis.liuying.shifts).forEach(shift => {
                if (shift.count > 0) html1 += `<li>${shift.name}: <span class="font-medium">${shift.count}</span> 件</li>`;
            });
            html1 += '</ul></div>';
            html1 += '</div>';
            analysisSection1.innerHTML = html1;

            // --- 2. 渲染單位總覽 (分院區彙總表) ---
            let html2 = '<div class="space-y-6">';
            
            const renderUnitSummaryTable = (campus, unitSummary) => {
                const depts = Object.keys(unitSummary).sort((a, b) => {
                    // 依總件數降序排列
                    const totalA = unitSummary[a].totalSend + unitSummary[a].totalReceive;
                    const totalB = unitSummary[b].totalSend + unitSummary[b].totalReceive;
                    return totalB - totalA; 
                });
                
                let grandTotalSend = 0;
                let grandTotalReceive = 0;
                let tableHtml = '';

                let hasData = depts.some(deptName => (unitSummary[deptName].totalSend + unitSummary[deptName].totalReceive) > 0);

                if (!hasData) {
                    tableHtml += `<p class="text-gray-500 italic mt-4">無 ${campus} 院區的郵件記錄。</p>`;
                    return tableHtml;
                }
                
                tableHtml += `<h5 class="text-lg font-semibold text-gray-700 mt-4 mb-2">${campus} 院區 - 單位總收送件數彙總</h5>`;
                tableHtml += '<div class="overflow-x-auto">';
                tableHtml += '<table class="min-w-full divide-y divide-gray-200 text-sm">';
                tableHtml += '<thead class="bg-gray-100"><tr><th class="px-3 py-2 text-left font-medium text-gray-600">單位名稱</th>';
                tableHtml += '<th class="px-3 py-2 text-right font-medium text-blue-600">總送件數</th>';
                tableHtml += '<th class="px-3 py-2 text-right font-medium text-green-600">總收件數</th>';
                tableHtml += '<th class="px-3 py-2 text-right font-medium text-gray-800">總計</th></tr></thead>';
                
                tableHtml += '<tbody class="bg-white divide-y divide-gray-200">';
                
                depts.forEach(deptName => {
                    const totals = unitSummary[deptName];
                    const total = totals.totalSend + totals.totalReceive;
                    
                    if (total === 0) return; 

                    grandTotalSend += totals.totalSend;
                    grandTotalReceive += totals.totalReceive;
                    
                    tableHtml += `<tr><td class="px-3 py-2 font-medium text-gray-900">${deptName}</td>`;
                    tableHtml += `<td class="px-3 py-2 text-right text-blue-600">${totals.totalSend || ''}</td>`;
                    tableHtml += `<td class="px-3 py-2 text-right text-green-600">${totals.totalReceive || ''}</td>`;
                    tableHtml += `<td class="px-3 py-2 text-right font-bold text-gray-900">${total}</td></tr>`;
                });

                // 總計行
                tableHtml += `<tr class="bg-gray-200 font-bold"><td class="px-3 py-2 text-gray-900">總計</td>`;
                tableHtml += `<td class="px-3 py-2 text-right text-blue-700">${grandTotalSend}</td>`;
                tableHtml += `<td class="px-3 py-2 text-right text-green-700">${grandTotalReceive}</td>`;
                tableHtml += `<td class="px-3 py-2 text-right text-indigo-700">${grandTotalSend + grandTotalReceive}</td></tr>`;

                tableHtml += '</tbody></table></div>';
                return tableHtml;
            };

            html2 += renderUnitSummaryTable('永康', unitSummaryByCampus['永康']);
            html2 += renderUnitSummaryTable('柳營', unitSummaryByCampus['柳營']);

            html2 += '</div>';
            analysisSection2.innerHTML = html2;
            
            console.log("「數據報表」分頁渲染完畢。");
        }
        
        /**
         * *** MODIFICATION: 渲染「視覺化圖表」分頁 ***
         */
        function renderAnalysisChartsTab(analysisData) {
            console.log("正在渲染「視覺化圖表」分頁...");

            try {
                // --- 銷毀舊圖表 (防止記憶體洩漏) ---
                if (chartMonthlyTrend) chartMonthlyTrend.destroy();
                if (chartCampusDonut) chartCampusDonut.destroy();
                if (chartTopUnits) chartTopUnits.destroy();
                if (chartSendReceive) chartSendReceive.destroy();

                const commonOptions = {
                    chart: {
                        fontFamily: 'Inter, sans-serif',
                        toolbar: { show: true },
                        animations: { enabled: true, easing: 'easeinout', speed: 800 }
                    },
                    colors: ['#4f46e5', '#10b981', '#f59e0b', '#3b82f6'], // Indigo, Green, Amber, Blue
                    tooltip: {
                        theme: 'light',
                        style: { fontSize: '14px' }
                    }
                };

                // --- 圖表 1: 年度趨勢 (曲線圖) ---
                const trendOptions = {
                    ...commonOptions,
                    series: [
                        { name: '永康-送件', data: analysisData.monthlyTrendData.yongkangSend },
                        { name: '永康-收件', data: analysisData.monthlyTrendData.yongkangReceive },
                        { name: '柳營-送件', data: analysisData.monthlyTrendData.liuyingSend },
                        { name: '柳營-收件', data: analysisData.monthlyTrendData.liuyingReceive }
                    ],
                    chart: { ...commonOptions.chart, type: 'area', height: 400 },
                    xaxis: {
                        categories: ['1月', '2月', '3月', '4月', '5月', '6月', '7月', '8月', '9月', '10月', '11月', '12月'],
                        title: { text: '月份' }
                    },
                    yaxis: { title: { text: '件數' } },
                    dataLabels: { enabled: false },
                    stroke: { curve: 'smooth', width: 3 },
                    fill: {
                        type: 'gradient',
                        gradient: {
                            shadeIntensity: 1,
                            opacityFrom: 0.7,
                            opacityTo: 0.1,
                            stops: [0, 90, 100]
                        }
                    },
                    legend: { position: 'top', horizontalAlign: 'left' }
                };
                chartMonthlyTrend = new ApexCharts(chartMonthlyTrendDiv, trendOptions);
                chartMonthlyTrend.render();

                // --- 圖表 2: 院區總量佔比 (環圈圖) ---
                const yongkangTotal = analysisData.analysis.yongkang.send + analysisData.analysis.yongkang.receive;
                const liuyingTotal = analysisData.analysis.liuying.send + analysisData.analysis.liuying.receive;
                const donutData = [yongkangTotal, liuyingTotal];
                const donutLabels = ['永康院區', '柳營院區'];
                
                const donutOptions = {
                    ...commonOptions,
                    series: (yongkangTotal > 0 || liuyingTotal > 0) ? donutData : [],
                    labels: donutLabels,
                    chart: { ...commonOptions.chart, type: 'donut', height: 400 },
                    colors: ['#4f46e5', '#f59e0b'], // 永康 (Indigo), 柳營 (Amber)
                    plotOptions: {
                        pie: {
                            donut: {
                                size: '65%',
                                labels: {
                                    show: true,
                                    total: { show: true, label: '總件數', fontSize: '20px', fontWeight: 600 }
                                }
                            }
                        }
                    },
                    legend: { show: true, position: 'bottom' },
                    noData: { text: '本月無資料' }
                };
                chartCampusDonut = new ApexCharts(chartCampusDonutDiv, donutOptions);
                chartCampusDonut.render();
                
                // --- 圖表 3: Top 10 單位 (橫條圖) ---
                const topUnits = analysisData.topUnitsData;
                const topUnitsOptions = {
                    ...commonOptions,
                    series: [{
                        name: '總件數',
                        data: topUnits.map(d => d.total)
                    }],
                    chart: { ...commonOptions.chart, type: 'bar', height: 400 },
                    plotOptions: {
                        bar: {
                            horizontal: true,
                            borderRadius: 4,
                            barHeight: '60%',
                            dataLabels: { position: 'top' }
                        }
                    },
                    dataLabels: {
                        enabled: true,
                        offsetX: 25,
                        style: { colors: ['#333'], fontSize: '12px' }
                    },
                    xaxis: {
                        categories: topUnits.map(d => d.unit),
                        title: { text: '總件數' }
                    },
                    yaxis: {
                        labels: {
                            style: { fontSize: '14px' }
                        }
                    },
                    grid: { xaxis: { lines: { show: true } } },
                    tooltip: { y: { formatter: (val) => `${val} 件` } },
                    noData: { text: '本月無資料' }
                };
                chartTopUnits = new ApexCharts(chartTopUnitsDiv, topUnitsOptions);
                chartTopUnits.render();
                
                // --- 圖表 4: 總送/收件比例 (儀表板) ---
                const totalSend = analysisData.analysis.yongkang.send + analysisData.analysis.liuying.send;
                const totalReceive = analysisData.analysis.yongkang.receive + analysisData.analysis.liuying.receive;
                
                const sendReceiveOptions = {
                    ...commonOptions,
                    series: (totalSend > 0 || totalReceive > 0) ? [totalSend, totalReceive] : [],
                    labels: ['總送件', '總收件'],
                    chart: { ...commonOptions.chart, type: 'radialBar', height: 400 },
                    colors: ['#3b82f6', '#10b981'], // 送件 (Blue), 收件 (Green)
                    plotOptions: {
                        radialBar: {
                            hollow: { size: '40%' },
                            dataLabels: {
                                name: { fontSize: '22px' },
                                value: { fontSize: '16px' },
                                total: {
                                    show: true,
                                    label: '總計',
                                    formatter: function (w) {
                                        return totalSend + totalReceive + ' 件';
                                    }
                                }
                            }
                        }
                    },
                    legend: { show: true, position: 'bottom' },
                    noData: { text: '本月無資料' }
                };
                chartSendReceive = new ApexCharts(chartSendReceiveDiv, sendReceiveOptions);
                chartSendReceive.render();


            } catch (error) {
                console.error("渲染圖表時發生錯誤:", error);
                chartVisualizationContent.innerHTML = `<p class="text-red-600">載入圖表時發生錯誤：${error.message}</p>`;
            }
        }
        
        /**
         * 處理點擊 "產生分析" 按鈕的事件
         */
        async function handleGenerateAnalysis() {
            const yearMonth = analysisMonthInput.value;
            if (!yearMonth) {
                analysisModalError.textContent = '請選擇一個月份。';
                analysisModalError.classList.remove('hidden');
                return;
            }
            analysisModalError.classList.add('hidden');
            console.log(`開始產生 ${yearMonth} 的分析...`);
            
            hideAnalysisModal();
            showAnalysisResultsModal(yearMonth);
            
            // 1. 產生數據 (同步)
            // *** MODIFICATION: 接收所有數據 ***
            const data = generateAnalysisData(yearMonth);
            
            if (!data) {
                analysisLoading.style.display = 'none';
                analysisContent.classList.remove('hidden');
                const errorMsg = `<p class="text-red-600 p-4">在 ${yearMonth} 月份沒有找到任何郵件記錄。</p>`;
                dataReportContent.innerHTML = errorMsg; // 顯示在第一個 tab
                chartVisualizationContent.innerHTML = errorMsg; // 顯示在第二個 tab
                return;
            }

            // 2. 渲染「數據報表」分頁
            renderAnalysisReportTab(data.analysis, data.unitSummaryByCampus);
            
            // 3. 渲染「視覺化圖表」分頁
            renderAnalysisChartsTab(data);
            
            // 顯示內容，隱藏主載入
            analysisLoading.style.display = 'none';
            analysisContent.classList.remove('hidden');
            
            // 4. 呼叫 AI (非同步)
            try {
                const aiResult = await callGeminiAPI(data.aiPrompt);
                
                // 將 AI 回應 (可能是 Markdown) 轉換為 HTML
                let htmlResult = aiResult
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') // Bold
                    .replace(/^\* (.*$)/gm, '<li>$1</li>') // Convert '* item' to '<li>item</li>'
                    .replace(/^\d+\. (.*$)/gm, '<li>$1</li>') // Convert '1. item' to '<li>item</li>'
                    
                    // 處理列表嵌套
                    .replace(/(<li>.*<\/li>)/gm, '<ul>$1</ul>') // Wrap <li> block in <ul>
                    .replace(/<\/ul>\s*<ul>/g, '') // Merge adjacent <ul>
                    .replace(/<\/li>\s*<li>/g, '</li><li>') // Merge <li>
                    
                    .replace(/\n\n/g, '<p></p>') // Double newline -> paragraph
                    .replace(/\n/g, '<br />') // Single newline -> <br>
                    .replace(/<p><\/p>/g, '') // Clean empty paragraphs
                    
                    // 清理 <br> 和列表的錯誤組合
                    .replace(/<br \/><ul>/g, '<ul>')
                    .replace(/<br \/><li>/g, '<li>')
                    .replace(/<\/li><br \/>/g, '</li>')
                    .replace(/<\/ul><br \/>/g, '</ul>');
                
                // 將不在列表中的 <br> 轉換為 <p>
                const segments = htmlResult.split(/(<ul>.*?<\/ul>)/g); // 按列表分割
                htmlResult = segments.map(seg => {
                    if (seg.startsWith('<ul>')) {
                        return seg; // 列表保持原樣
                    }
                    // 非列表部分，用 <p> 包裝
                    return seg.split(/<br \/>\s*<br \/>/g) // 按段落分割
                             .map(p => p.trim())
                             .filter(p => p.length > 0)
                             .map(p => `<p>${p.replace(/<br \/>/g, ' ')}</p>`) // 將段落內的 <br> 轉為空白
                             .join('');
                }).join('');

                aiSuggestionContent.innerHTML = htmlResult;
            } catch (error) {
                console.error("AI 分析失敗:", error);
                aiSuggestionContent.innerHTML = `<p class="text-red-500">AI 建議載入失敗：${error.message}</p>`;
            } finally {
                aiSuggestionLoading.style.display = 'none';
            }
        }


        // --- 10. Modals 與重設功能 ---
        // ... (showResetModal, hideResetModal, resetCurrentDateCounts - 內容不變) ...
        function showResetModal() {
            resetDateDisplay.textContent = state.currentDate;
            resetModal.classList.remove('hidden');
        }

        function hideResetModal() {
            resetModal.classList.add('hidden');
        }

        function resetCurrentDateCounts() {
            console.log(`清空日期 ${state.currentDate} 的計數...`);
            delete dataFromFirestore.counts[state.currentDate];
            isDataDirty = true;
            updateSaveButtonState();

            saveDataToFirestore().then(() => {
                console.log("清空操作已儲存");
                renderDepartmentGrid();
                updateTotals();
                hideResetModal();
            }).catch(error => {
                console.error("儲存清空操作失敗:", error);
                displayError("清空資料時儲存失敗，請稍後檢查。");
                renderDepartmentGrid();
                updateTotals();
                hideResetModal();
            });
        }

        // ... (showReportDownloadModal, hideReportDownloadModal, handleReportDownload, handleReportTypeChange - 內容不變) ...
        function showReportDownloadModal() {
            console.log("顯示報表下載 Modal");
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            
            // 預設為月報表
            reportTypeMonth.checked = true;
            reportPeriodLabel.textContent = '選擇月份';
            reportPeriodInput.type = 'month';
            reportPeriodInput.value = `${year}-${month}`;

            reportDownloadError.classList.add('hidden');
            reportDownloadModal.classList.remove('hidden');
        }

        function hideReportDownloadModal() {
            reportDownloadModal.classList.add('hidden');
        }

        function handleReportDownload() {
            console.log("處理報表下載動作");
            const reportType = document.querySelector('input[name="report-type"]:checked').value;
            const period = reportPeriodInput.value;
            
            if (!period) {
                reportDownloadError.textContent = `請選擇一個有效的 ${reportType === 'month' ? '月份' : '年份'}。`;
                reportDownloadError.classList.remove('hidden');
                return;
            }
            
            // 呼叫統一的匯出函式
            exportSelectedReport(period, reportType);
        }

        function handleReportTypeChange(event) {
            const type = event.target.value;
            reportDownloadError.classList.add('hidden'); // 清除錯誤訊息
            
            if (type === 'month') {
                reportPeriodLabel.textContent = '選擇月份';
                reportPeriodInput.type = 'month';
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                reportPeriodInput.value = `${year}-${month}`; // 預設為當月
                reportPeriodInput.removeAttribute('max');
                reportPeriodInput.removeAttribute('pattern');
            } else if (type === 'year') {
                reportPeriodLabel.textContent = '選擇年份';
                reportPeriodInput.type = 'number';
                reportPeriodInput.pattern = '\\d{4}';
                reportPeriodInput.value = new Date().getFullYear(); // 預設為當年
                reportPeriodInput.max = new Date().getFullYear();
            }
        }
        
        // ... (showAddDeptModal, hideAddDeptModal, confirmAddDept - 內容不變) ...
        function showAddDeptModal() {
            newDeptNameInput.value = '';
            addDeptError.classList.add('hidden');
            addDeptModal.classList.remove('hidden');
            newDeptNameInput.focus();
        }

        function hideAddDeptModal() {
            addDeptModal.classList.add('hidden');
        }

        function confirmAddDept() {
            const newName = newDeptNameInput.value.trim();
            if (!newName) {
                addDeptError.textContent = '單位名稱不可空白。';
                addDeptError.classList.remove('hidden');
                return;
            }
            if (dataFromFirestore.departments.some(d => d.name === newName)) {
                addDeptError.textContent = '這個名稱的單位已經存在。';
                addDeptError.classList.remove('hidden');
                return;
            }
            console.log(`新增單位: ${newName}`);
            const newDept = {
                id: `DYN_${Date.now()}`,
                name: newName
            };
            console.log("新單位物件:", newDept);
            dataFromFirestore.departments.push(newDept);
            const addBtnIndex = dataFromFirestore.layoutOrder.indexOf('DYN_ADD');
            if (addBtnIndex !== -1) {
                dataFromFirestore.layoutOrder.splice(addBtnIndex, 0, newDept.id);
                console.log("插入新單位到 layoutOrder:", dataFromFirestore.layoutOrder);
            } else {
                console.warn("未找到 DYN_ADD 按鈕，將新單位添加到 layoutOrder 末尾。");
                dataFromFirestore.layoutOrder.push(newDept.id);
            }
            isDataDirty = true;
            updateSaveButtonState();
            renderDepartmentGrid();
            hideAddDeptModal();
        }
        
        function showAnalysisModal() {
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            analysisMonthInput.value = `${year}-${month}`;
            analysisModalError.classList.add('hidden');
            analysisModal.classList.remove('hidden');
        }

        function hideAnalysisModal() {
            analysisModal.classList.add('hidden');
        }
        
        // *** MODIFICATION: 顯示分析 Modal 時，重置 Tabs ***
        function showAnalysisResultsModal(yearMonth) {
            analysisResultsTitle.textContent = `${yearMonth} 月度統計分析報告`;
            analysisLoading.style.display = 'flex'; // 顯示主載入
            analysisContent.classList.add('hidden'); // 隱藏內容
            
            // 重置 Tabs
            if (dataReportContent) dataReportContent.classList.remove('hidden');
            if (chartVisualizationContent) chartVisualizationContent.classList.add('hidden');
            if (tabBtnReport) tabBtnReport.classList.add('active');
            if (tabBtnChart) tabBtnChart.classList.remove('active');
            
            // 清空舊內容
            if (analysisSection1) analysisSection1.innerHTML = '';
            if (analysisSection2) analysisSection2.innerHTML = '';
            if (aiSuggestionContent) aiSuggestionContent.innerHTML = '';
            
            // 銷毀舊圖表
            if (chartMonthlyTrend) chartMonthlyTrend.destroy();
            if (chartCampusDonut) chartCampusDonut.destroy();
            if (chartTopUnits) chartTopUnits.destroy();
            if (chartSendReceive) chartSendReceive.destroy();
            chartMonthlyTrend = chartCampusDonut = chartTopUnits = chartSendReceive = null;
            if (chartMonthlyTrendDiv) chartMonthlyTrendDiv.innerHTML = '';
            if (chartCampusDonutDiv) chartCampusDonutDiv.innerHTML = '';
            if (chartTopUnitsDiv) chartTopUnitsDiv.innerHTML = '';
            if (chartSendReceiveDiv) chartSendReceiveDiv.innerHTML = '';

            if (aiSuggestionLoading) aiSuggestionLoading.style.display = 'flex'; // 顯示 AI 載入
            
            analysisResultsModal.classList.remove('hidden');
            // 確保 lucide icons 被渲染
            if (typeof lucide !== 'undefined' && lucide.createIcons) {
                try { lucide.createIcons(); } catch(e) { console.error("渲染分析 modal lucide 失敗:", e); }
            }
        }
        
        function hideAnalysisResultsModal() {
            analysisResultsModal.classList.add('hidden');
        }


        // --- 11. Firebase 初始化與資料綁定 ---
        // ... (displayError, handleDataLoad, initFirebase - 內容不變) ...
        function displayError(message) {
            console.error("錯誤:", message);
            if (errorMessageDiv) {
                errorMessageDiv.textContent = message;
                errorMessageDiv.style.display = 'block';
            }
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            if (departmentGrid) {
                departmentGrid.classList.add('hidden');
            }
        }

        function handleDataLoad(docData) {
            console.log("handleDataLoad 開始執行...", docData ? "找到文件資料" : "未找到文件資料");
            try {
                if (docData) {
                    console.log("從 Firestore 載入資料:", docData);
                    dataFromFirestore.counts = (typeof docData.counts === 'object' && docData.counts !== null) ? docData.counts : {};
                    const savedDepts = Array.isArray(docData.departments) ? docData.departments : [...DEFAULT_DEPARTMENTS];
                    const savedLayout = Array.isArray(docData.layoutOrder) ? docData.layoutOrder : DEFAULT_DEPARTMENTS.map(d => d.id);

                    if (!savedDepts.some(d => d.id === 'DYN_ADD')) {
                        console.log("departments 缺少 DYN_ADD，正在添加...");
                        savedDepts.push({ id: 'DYN_ADD', name: '新增單位...' });
                    }
                    dataFromFirestore.departments = savedDepts.filter(d => d && d.id && d.name);

                    let validDeptIds = new Set(dataFromFirestore.departments.map(d => d.id));
                    let layout = savedLayout.filter(id => id && id !== 'DYN_ADD' && validDeptIds.has(id));
                    layout = [...new Set(layout)];
                    dataFromFirestore.departments.forEach(dept => {
                        if (dept.id !== 'DYN_ADD' && !layout.includes(dept.id)) {
                            console.warn(`layoutOrder 缺少單位 ${dept.name} (${dept.id})，正在補加到末尾`);
                            layout.push(dept.id);
                        }
                    });
                    layout.push('DYN_ADD');
                    dataFromFirestore.layoutOrder = layout;
                    console.log("整理後的 layoutOrder:", dataFromFirestore.layoutOrder);

                } else {
                    console.log("偵測到新使用者或無資料，正在建立預設資料...");
                    dataFromFirestore = {
                        counts: {},
                        departments: [...DEFAULT_DEPARTMENTS],
                        layoutOrder: DEFAULT_DEPARTMENTS.map(d => d.id)
                    };
                }

                isDataLoaded = true;
                console.log("資料處理完成，準備渲染畫面...");

                renderShiftTabs();
                renderDepartmentGrid();
                updateTotals();

                isDataDirty = false;
                updateSaveButtonState();

                if (!docData) {
                    console.log("首次載入，自動儲存預設資料...");
                    saveDataToFirestore();
                }
                console.log("handleDataLoad 成功完成");
            } catch (error) {
                console.error("處理載入的資料時發生錯誤:", error);
                displayError("處理載入的資料時發生錯誤：" + error.message);
                isDataLoaded = true;
                loadingIndicator.style.display = 'none';
            }
        }

        async function initFirebase() {
            console.log("initFirebase 開始執行...");
            if (!auth || !db) {
                console.error("Firebase Auth 或 Firestore 未成功初始化，無法繼續。");
                displayError("資料庫服務初始化失敗，請稍後重試或聯繫管理員。");
                if(loadingIndicator) loadingIndicator.style.display = 'none';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                console.log("onAuthStateChanged 觸發");
                if (user) {
                    console.log("Firebase 認證成功, User ID:", user.uid);
                    userId = user.uid;

                    if (unsubscribeSnapshot) {
                        console.log("停止舊的 Snapshot 監聽...");
                        unsubscribeSnapshot();
                        unsubscribeSnapshot = null;
                    }

                    try {
                        dbRef = doc(db, "artifacts", appId, "users", userId, "mailData", "singleton");
                        console.log("Firestore 文件路徑:", `artifacts/${appId}/users/${userId}/mailData/singleton`);

                        console.log("正在設定 Firestore Snapshot 監聽...");
                        unsubscribeSnapshot = onSnapshot(dbRef, (docSnap) => {
                            console.log("收到 Snapshot 更新");
                            if (docSnap.exists()) {
                                console.log("文件存在，準備處理資料...");
                                handleDataLoad(docSnap.data());
                            } else {
                                console.log("Firestore 文件不存在，準備載入預設值。");
                                handleDataLoad(null);
                            }
                        }, (error) => {
                            console.error("Firestore 監聽失敗:", error);
                            displayError("無法監聽資料庫變更，請檢查網路連線或 Firestore 權限。錯誤：" + error.message);
                            isDataLoaded = true;
                            if(loadingIndicator) loadingIndicator.style.display = 'none';
                        });
                        console.log("Snapshot 監聽已設定");
                    } catch (e) {
                        console.error("設定 Firestore 文件參照或監聽時出錯:", e);
                        displayError("連接資料庫時發生錯誤：" + e.message);
                        isDataLoaded = true;
                        if(loadingIndicator) loadingIndicator.style.display = 'none';
                    }

                } else {
                    console.log("使用者未登入 / 已登出。");
                    if (unsubscribeSnapshot) {
                        console.log("使用者未登入，停止 Snapshot 監聽...");
                        unsubscribeSnapshot();
                        unsubscribeSnapshot = null;
                    }
                    userId = null;
                    dbRef = null;
                    displayError("使用者未登入，無法載入或儲存資料。請重新整理頁面。");
                    isDataLoaded = true;
                    if(loadingIndicator) loadingIndicator.style.display = 'none';
                }
            });

            try {
                const token = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                if (token) {
                    console.log("正在使用 __initial_auth_token 登入...");
                    await signInWithCustomToken(auth, token);
                    console.log("使用 Token 登入成功");
                } else {
                    console.log("未提供 Token，正在執行匿名登入...");
                    await signInAnonymously(auth);
                    console.log("匿名登入成功");
                }
                console.log("Firebase 登入流程完成。等待 onAuthStateChanged 回應...");
            } catch (error) {
                console.error("Firebase 登入失敗:", error);
                displayError("無法登入 Firebase 驗證服務，請檢查您的網路連線或稍後重試。錯誤：" + error.message);
                isDataLoaded = true;
                if(loadingIndicator) loadingIndicator.style.display = 'none';
            }
        }


        // --- 12. 程式啟動點 (*** MODIFICATION: 結構重組 ***) ---
        function initializeAppListeners() {
            console.log("initializeAppListeners 執行");
            
            // *** MODIFICATION: 所有 DOM 抓取移至此處 ***
            console.log("正在綁定 DOM 元素...");
            shiftTabsContainer = document.getElementById('shift-tabs-container');
            departmentGrid = document.getElementById('department-grid');
            dateInput = document.getElementById('current-date');
            shiftTotalEl = document.getElementById('shift-total');
            dayTotalEl = document.getElementById('day-total');
            toggleEditBtn = document.getElementById('toggle-edit-layout');
            editLayoutText = document.getElementById('edit-layout-text');
            exportBtn = document.getElementById('export-excel');
            resetBtn = document.getElementById('reset-counts');
            resetModal = document.getElementById('reset-modal');
            cancelResetBtn = document.getElementById('cancel-reset');
            confirmResetBtn = document.getElementById('confirm-reset');
            resetDateDisplay = document.getElementById('reset-date-display');
            exportReportModalBtn = document.getElementById('export-report-modal-btn');
            reportDownloadModal = document.getElementById('report-download-modal');
            cancelReportDownloadBtn = document.getElementById('cancel-report-download');
            confirmReportDownloadBtn = document.getElementById('confirm-report-download');
            reportPeriodInput = document.getElementById('report-period-input');
            reportPeriodLabel = document.getElementById('report-period-label');
            reportDownloadError = document.getElementById('report-download-error');
            reportTypeMonth = document.getElementById('report-type-month');
            reportTypeYear = document.getElementById('report-type-year');
            addDeptModal = document.getElementById('add-dept-modal');
            cancelAddDeptBtn = document.getElementById('cancel-add-dept');
            confirmAddDeptBtn = document.getElementById('confirm-add-dept');
            newDeptNameInput = document.getElementById('new-dept-name');
            addDeptError = document.getElementById('add-dept-error');
            saveDataBtn = document.getElementById('save-data');
            saveDataText = document.getElementById('save-data-text');
            loadingIndicator = document.getElementById('loading-indicator');
            errorMessageDiv = document.getElementById('error-message');
            showInstructionsBtn = document.getElementById('show-instructions-btn');
            instructionsPage = document.getElementById('instructions-page');
            counterPage = document.getElementById('counter-page');
            backToCounterBtn = document.getElementById('back-to-counter-btn');
            showAnalysisModalBtn = document.getElementById('show-analysis-modal');
            analysisModal = document.getElementById('analysis-modal');
            cancelAnalysisModalBtn = document.getElementById('cancel-analysis-modal');
            confirmGenerateAnalysisBtn = document.getElementById('confirm-generate-analysis');
            analysisMonthInput = document.getElementById('analysis-month-input');
            analysisModalError = document.getElementById('analysis-modal-error');
            analysisResultsModal = document.getElementById('analysis-results-modal');
            closeAnalysisResultsBtn = document.getElementById('close-analysis-results');
            closeAnalysisResultsBottomBtn = document.getElementById('close-analysis-results-bottom');
            analysisLoading = document.getElementById('analysis-loading');
            analysisContent = document.getElementById('analysis-content');
            analysisResultsTitle = document.getElementById('analysis-results-title');
            tabBtnReport = document.getElementById('tab-btn-report');
            tabBtnChart = document.getElementById('tab-btn-chart');
            dataReportContent = document.getElementById('data-report-content');
            chartVisualizationContent = document.getElementById('chart-visualization-content');
            analysisSection1 = document.getElementById('analysis-section-1');
            analysisSection2 = document.getElementById('analysis-section-2');
            analysisSection3 = document.getElementById('analysis-section-3');
            aiSuggestionLoading = document.getElementById('ai-suggestion-loading');
            aiSuggestionContent = document.getElementById('ai-suggestion-content');
            chartMonthlyTrendDiv = document.getElementById('chart-monthly-trend');
            chartCampusDonutDiv = document.getElementById('chart-campus-donut');
            chartTopUnitsDiv = document.getElementById('chart-top-units');
            chartSendReceiveDiv = document.getElementById('chart-send-receive');
            console.log("DOM 元素綁定完成。");

            // *** MODIFICATION: 增加核心 DOM 檢查 ***
            if (!departmentGrid || !loadingIndicator || !dateInput || !shiftTabsContainer) {
                console.error("【嚴重錯誤】一個或多個核心 DOM 元素未找到。應用程式無法啟動。");
                displayError("【嚴重錯誤】頁面核心元件載入失敗，請強制重新整理 (Ctrl+F5)。");
                return;
            }

            // ---------------------------------
            // 核心啟動邏輯 (現在是安全的)
            // ---------------------------------

            if (dateInput) {
                dateInput.value = getFormattedDate(new Date());
                state.currentDate = dateInput.value;
                console.log("初始日期設定為:", state.currentDate);
            }
            
            console.log("渲染初始班次分頁...");
            renderShiftTabs();
            
            console.log("準備初始化 Sortable...");
            initSortable();

            console.log("準備初始化 Lucide icons...");
            try {
                setTimeout(() => {
                    if (typeof lucide !== 'undefined' && lucide.createIcons) {
                        console.log("正在初始化 Lucide icons...");
                        lucide.createIcons();
                        console.log("Lucide icons 初始化成功");
                    } else {
                        console.warn('Lucide icons library 可能未完全載入或 createIcons 方法不存在。');
                    }
                }, 500);
            } catch (error) {
                console.error('初始化 Lucide icons 時出錯:', error);
            }

            // 綁定事件
            console.log("綁定事件監聽器...");
            if (dateInput) {
                dateInput.addEventListener('change', (e) => {
                    console.log("日期變更觸發");
                    if (!isDataLoaded) {
                        console.log("資料尚未載入，忽略日期變更事件");
                        return;
                    }
                    state.currentDate = e.target.value;
                    console.log("日期變更為:", state.currentDate);
                    renderDepartmentGrid();
                    updateTotals();
                });
            }
            if (toggleEditBtn) toggleEditBtn.addEventListener('click', toggleEditMode);
            if (exportBtn) exportBtn.addEventListener('click', exportToExcel);
            if (resetBtn) resetBtn.addEventListener('click', showResetModal);
            if (cancelResetBtn) cancelResetBtn.addEventListener('click', hideResetModal);
            if (confirmResetBtn) confirmResetBtn.addEventListener('click', resetCurrentDateCounts);
            
            // 報表下載事件綁定
            if (exportReportModalBtn) exportReportModalBtn.addEventListener('click', showReportDownloadModal);
            if (cancelReportDownloadBtn) cancelReportDownloadBtn.addEventListener('click', hideReportDownloadModal);
            if (confirmReportDownloadBtn) confirmReportDownloadBtn.addEventListener('click', handleReportDownload);
            if (reportTypeMonth) reportTypeMonth.addEventListener('change', handleReportTypeChange);
            if (reportTypeYear) reportTypeYear.addEventListener('change', handleReportTypeChange);
            
            if (cancelAddDeptBtn) cancelAddDeptBtn.addEventListener('click', hideAddDeptModal);
            if (confirmAddDeptBtn) confirmAddDeptBtn.addEventListener('click', confirmAddDept);
            if (saveDataBtn) saveDataBtn.addEventListener('click', saveDataToFirestore);
            
            // 導覽事件
            if (showInstructionsBtn) showInstructionsBtn.addEventListener('click', () => navigateTo('instructions'));
            if (backToCounterBtn) backToCounterBtn.addEventListener('click', () => navigateTo('counter'));
            
            // 分析 Modal 事件
            if (showAnalysisModalBtn) showAnalysisModalBtn.addEventListener('click', showAnalysisModal);
            if (cancelAnalysisModalBtn) cancelAnalysisModalBtn.addEventListener('click', hideAnalysisModal);
            if (confirmGenerateAnalysisBtn) confirmGenerateAnalysisBtn.addEventListener('click', handleGenerateAnalysis);
            if (closeAnalysisResultsBtn) closeAnalysisResultsBtn.addEventListener('click', hideAnalysisResultsModal);
            if (closeAnalysisResultsBottomBtn) closeAnalysisResultsBottomBtn.addEventListener('click', hideAnalysisResultsModal);

            // 分析 Modal Tab 事件
            if (tabBtnReport) {
                tabBtnReport.addEventListener('click', () => {
                    dataReportContent.classList.remove('hidden');
                    chartVisualizationContent.classList.add('hidden');
                    tabBtnReport.classList.add('active');
                    tabBtnChart.classList.remove('active');
                });
            }
            if (tabBtnChart) {
                tabBtnChart.addEventListener('click', () => {
                    dataReportContent.classList.add('hidden');
                    chartVisualizationContent.classList.remove('hidden');
                    tabBtnReport.classList.remove('active');
                    tabBtnChart.classList.add('active');
                    // 關鍵：觸發 resize 事件強制圖表重繪
                    window.dispatchEvent(new Event('resize'));
                });
            }

            
            console.log("事件監聽器綁定完成");

            // 啟動 Firebase
            console.log("準備啟動 Firebase...");
            initFirebase();
            
            console.log("腳本末尾");
        }
        
        // 確保 DOM 完全載入後再執行所有初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAppListeners);
        } else {
            // DOM 已經載入
            initializeAppListeners();
        }

    </script>
</body>
</html>
